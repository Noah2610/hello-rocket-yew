#!/bin/bash

# shellcheck source=./share.sh
_dir="$( dirname "$0" )"
source "${_dir}/share.sh"
unset _dir

set -e

check "cargo-web"

# Build with cargo-web
function build_web {
  cargo web build             \
    --package "$FRONTEND_BIN" \
    --bin "$FRONTEND_BIN"     \
    --runtime "$JS_RUNTIME"   \
    $CARGO_ARGS
}

# Copy generated js and wasm files to backend directory
function copy_files {
  [ -d "$STATIC_BACKEND" ] || mkdir -p "$STATIC_BACKEND"

  local static
  local target_dir="target/wasm32-unknown-unknown/${PROFILE}"
  check_dir "$target_dir"

  # Copy files generated by cargo-web to the backend's static directory
  cp                       \
    "${target_dir}"/*.js   \
    "${target_dir}"/*.wasm \
    "$STATIC_BACKEND"
  # Also copy the frontend's static directory's files, if it exists
  if [ -d "$STATIC_FRONTEND" ]; then
    cp -r                    \
      "${STATIC_FRONTEND}"/* \
      "$STATIC_BACKEND"
  fi
}

build_web
copy_files
